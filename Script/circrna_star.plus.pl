# Author: Marcel Smid
# License: CC:BY:SA:NC (Creative Commons Attribution-ShareAlike-NonCommercial 4.0 International)
# Disclaimer: author is not professionally trained as programmer, and realizes TIMTOWTDI.
#
# find circular RNAs, using mapped reads with mate spanning the junction
# prerequisites:
#  DATA 
#-RNA processed without a poly(A) selection step
#-paired-end sequence data
#-mapped by the STAR aligning software (https://github.com/alexdobin/STAR)
#-bam file sorted and indexed
#   -expects prefix 'chr' for chromosomes
#
#  Perl and other necessary files / tools
#-package File::Find
#-samtools (https://github.com/samtools/)
# -Gencode gene annotation, gtf format (ftp://ftp.ebi.ac.uk/pub/databases/gencode/)
#
#
# 
############        VERSION DEVELOPED FOR WINDOWS BOX, HARDCODED PATHS 
############               - set lines 27-33


use File::Find;
#location of bam files (.bai needed!)
$dir = "/molbio/projects/rabbit/unkp_zsofi/circRNA-star/test-site/in/";
#location of output files
$outdir = "/molbio/projects/rabbit/unkp_zsofi/circRNA-star/test-site/tmp/";
#location of samtools
$samdir = "/usr/local/molbio/bin/";
#location of Gencode GTF
$gtf = "/molbio/flatfiles/genomes/oc/Oryctolagus_cuniculus.OryCun2.0.104.gtf ";

# patterns of read-flags, as provided by SAM specifications
$pattern  = " 2129 2209 2193 2145";
$pattern2 = "83 163 147 99";

# needed for windows, otherwise samtools will not auto-close after each bam file
# optional change to wanted chromosomes only
$chr_string = "1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 X MT GL018699 GL018700 GL018701 GL018702 GL018703 GL018704 GL018705 GL018706 GL018707 GL018708 GL018709 GL018710 GL018711 GL018712 GL018713 GL018714 GL018719 GL018715 GL018717 GL018716 GL018718 GL018720 GL018723 GL018724 GL018721 GL018725 GL018722 GL018726 GL018727 GL018730 GL018728 GL018731 GL018729 GL018732 GL018734 GL018733 GL018735 GL018736 GL018738 GL018740 GL018737 GL018741 GL018739 GL018744 GL018742 GL018743 GL018745 GL018748 GL018746 GL018747 GL018752 GL018749 GL018750 GL018751 GL018754 GL018753 GL018755 GL018758 GL018757 GL018756 GL018759 GL018760 GL018761 GL018763 GL018762 GL018764 GL018772 GL018765 GL018766 GL018767 GL018768 GL018769 GL018774 GL018773 GL018770 GL018771 GL018775 GL018776 GL018785 GL018777 GL018782 GL018781 GL018779 GL018786 GL018792 GL018778 GL018796 GL018780 GL018783 GL018784 GL018787 GL018789 GL018790 GL018788 GL018799 GL018805 GL018794 GL018791 GL018793 GL018795 GL018797 GL018798 GL018818 GL018800 GL018804 GL018806 GL018809 GL018803 GL018801 GL018808 GL018832 GL018802 GL018807 GL018811 GL018812 GL018810 GL018821 GL018814 GL018817 GL018813 GL018815 GL018816 GL018826 GL018820 GL018839 GL018822 GL018829 GL018819 GL018827 GL018825 GL018828 GL018823 GL018833 GL018824 GL018830 GL018831 GL018834 GL018835 GL018841 GL018838 GL018836 GL018837 GL018840 GL018856 GL018854 GL018844 GL018842 GL018843 GL018848 GL018845 GL018847 GL018872 GL018887 GL018877 GL018851 GL018846 GL018849 GL018855 GL018865 GL018862 GL018850 GL018857 GL018853 GL018852 GL018869 GL018870 GL018879 GL018866 GL018859 GL018858 GL018861 GL018864 GL018860 GL018867 GL018875 GL018863 GL018868 GL018885 GL018925 GL018871 GL018876 GL018900 GL018873 GL018888 GL018921 GL018878 GL018874 GL018880 GL018905 GL018917 GL018881 GL018903 GL018882 GL018922 GL018883 GL018901 GL018893 GL018884 GL018899 GL018891 GL018904 GL018938 GL018890 GL018894 GL018907 GL018886 GL018898 GL018919 GL018892 GL018895 GL018896 GL018889 GL018913 GL018897 GL018935 GL018911 GL018909 GL019038 GL018902 GL018906 GL018934 GL018966 GL018908 GL019061 GL018915 GL018924 GL018914 GL018916 GL018920 GL018912 GL018910 GL018978 GL018918 GL018929 GL018923 GL018936 GL018930 GL018926 GL018933 GL018928 GL018927 GL018931 GL018959 GL019020 GL018941 GL018939 GL018947 GL018945 GL018951 GL019022 GL018942 GL018997 GL018940 GL018937 GL018944 GL018953 GL018946 GL018970 GL018943 GL018984 GL018979 GL018950 GL018954 GL018949 GL018952 GL018987 GL018960 GL018948 GL018994 GL018964 GL018991 GL018962 GL018957 GL018956 GL018968 GL018963 GL018955 GL018969 GL018965 GL018974 GL018958 GL018980 GL019014 GL019012 GL018975 GL018961 GL019008 GL018967 GL018973 GL018983 GL018972 GL018976 GL019052 GL018971 GL019015 GL019026 GL018982 GL018986 GL019011 GL019006 GL018985 GL018996 GL018988 GL018999 GL019086 GL019116 GL018981 AAGW02076170 GL019033 GL018992 GL018989 GL018993 GL018990 GL019010 GL019002 GL019005 GL019095 GL018995 GL019003 GL019023 GL019000 GL019004 GL018998 GL019123 GL019037 GL019007 GL019009 GL019016 GL019013 GL019021 GL019019 GL019126 GL019018 GL019039 GL019110 GL019047 GL019017 GL019186 GL019223 GL019106 GL019024 GL019032 GL019069 GL019035 GL019028 GL019059 GL019034 GL019042 GL019027 GL019030 GL019225 GL019219 GL019031 GL019058 GL019029 GL019065 GL019040 GL019044 GL019053 GL019051 GL019048 GL019074 GL019049 GL019045 GL019043 GL019050 AAGW02077230 GL019046 GL019076 GL019062 GL019096 GL019060 GL019054 GL019055 GL019064 GL019068 GL019057 GL019070 GL019103 GL019056 GL019075 GL019063 GL019140 GL019067 GL019084 GL019320 GL019071 GL019066 GL019079 GL019139 GL019077 GL019152 GL019088 GL019091 GL019072 GL019073 GL019081 GL019083 GL019085 GL019082 GL019102 GL019093 GL019141 GL019087 GL019104 GL019089 GL019090 GL019133 GL019098 GL019130 GL019111 GL019094 GL019101 GL019100 GL019109 GL019105 GL019108 GL019097 GL019099 AAGW02077833 GL019114 GL019112 GL019122 GL019121 GL019156 GL019119 GL019127 GL019107 GL019134 GL019124 GL019129 GL019120 GL019125 GL019143 GL019115 GL019118 GL019138 GL019159 GL019117 GL019203 GL019173 GL019135 GL019180 GL019144 GL019151 GL019191 GL019142 GL019136 GL019132 GL019153 GL019160 GL019137 GL019146 GL019194 GL019150 GL019155 GL019163 GL019154 AAGW02078230 GL019172 GL019200 GL019147 GL019162 GL019182 GL019145 GL019149 GL019157 GL019170 GL019166 GL019196 GL019161 GL019158 GL019212 GL019174 GL019167 GL019168 GL019165 GL019164 GL019177 AAGW02078537 GL019183 GL019169 GL019178 GL019171 GL019206 GL019213 GL019181 GL019179 GL019175 GL019193 GL019176 GL019185 GL019218 GL019192 GL019242 GL019204 GL019197 GL019228 GL019201 GL019278 GL019188 GL019199 GL019195 GL019253 GL019198 AAGW02078775 GL019286 GL019202 GL019207 GL019215 GL019205 GL019208 GL019221 GL019211 GL019386 GL019220 GL019234 GL019214 GL019210 GL019232 AAGW02078982 GL019236 GL019224 GL019259 GL019235 GL019249 GL019233 GL019237 GL019231 GL019313 GL019238 GL019257 AAGW02079106 GL019240 GL019250 GL019261 GL019246 GL019306 GL019239 GL019266 GL019282 AAGW02079147 GL019294 GL019267 GL019243 GL019245 GL019252 GL019248 GL019258 GL019262 GL019260 GL019256 AAGW02079168 GL019247 GL019263 GL019251 GL019254 AAGW02079214 GL019272 GL019264 AAGW02079242 GL019290 GL019275 GL019274 GL019283 GL019273 GL019269 GL019265 GL019314 GL019268 GL019298 AAGW02079307 GL019270 GL019277 AAGW02079327 GL019295 GL019280 GL019271 GL019279 GL019276 GL019329 GL019308 GL019310 AAGW02079371 GL019289 GL019300 GL019284 GL019302 GL019438 GL019297 GL019296 GL019304 GL019339 GL019309 AAGW02079515 GL019333 GL019340 GL019318 GL019305 AAGW02079587 GL019311 AAGW02079588 GL019349 GL019375 GL019317 GL019327 GL019316 GL019353 GL019359 GL019315 GL019330 GL019319 GL019323 AAGW02079657 AAGW02079658 GL019336 AAGW02079674 GL019331 GL019344 GL019337 AAGW02079688 GL019416 GL019377 GL019364 GL019346 GL019332 GL019361 GL019418 GL019360 GL019342 GL019334 GL019335 GL019394 GL019372 GL019407 GL019356 GL019351 GL019434 GL019343 GL019355 GL019347 GL019345 GL019397 GL019412 GL019452 GL019363 GL019472 GL019369 GL019396 GL019458 GL019357 GL019362 GL019358 GL019389 GL019366 GL019400 GL019367 GL019370 AAGW02079913 GL019371 GL019384 GL019368 GL019365 GL019422 GL019373 GL019378 GL019380 GL019399 GL019427 GL019383 GL019391 GL019462 GL019379 GL019406 GL019376 GL019430 GL019446 GL019385 GL019387 GL019442 GL019393 GL019444 GL019382 GL019581 GL019429 GL019410 GL019392 GL019388 AAGW02079997 GL019395 GL019402 GL019404 AAGW02080057 GL019401 GL019398 GL019453 GL019469 GL019426 GL019424 AAGW02080074 GL019433 GL019411 GL019448 AAGW02080085 GL019403 GL019435 GL019461 GL019454 GL019415 GL019405 GL019419 AAGW02080103 GL019420 GL019641 GL019443 GL019455 GL019456 GL019441 GL019437 GL019431 AAGW02080168 GL019480 GL019449 AAGW02080217 GL019440 GL019725 AAGW02080234 AAGW02080240 GL019432 GL019557 GL019464 GL019459 GL019496 GL019504 GL019476 AAGW02080326 GL019460 GL019486 GL019445 GL019739 GL019499 GL019451 GL019514 GL019497 GL019463 GL019467 GL019508 GL019473 GL019494 AAGW02080430 GL019475 GL019478 GL019471 GL019482 GL019559 GL019474 AAGW02080442 GL019573 GL019518 GL019524 GL019570 GL019507 GL019501 GL019487 GL019510 GL019527 GL019506 GL019531 GL019492 GL019483 AAGW02080504 GL019481 GL019718 GL019578 GL019503 AAGW02080517 GL019520 GL019534 GL019513 GL019502 GL019523 AAGW02080613 GL019512 GL019596 GL019533 GL019582 GL019519 GL019540 GL019544 GL019679 GL019516 GL019525 GL019538 GL019563 AAGW02080699 GL019599 GL019567 GL019564 GL019553 GL019583 GL019545 GL019541 AAGW02080733 AAGW02080735 GL019571 GL019537 GL019543 GL019536 GL019555 AAGW02080770 GL019667 GL019539 GL019552 GL019546 GL019568 GL019569 AAGW02080791 GL019579 GL019565 GL019593 AAGW02080820 AAGW02080821 GL019556 GL019554 GL019561 GL019580 GL019609 GL019575 GL019577 GL019572 GL019600 GL019576 GL019584 AAGW02080938 GL019616 AAGW02080941 GL019588 AAGW02080961 AAGW02080967 GL019589 GL019606 GL019619 GL019591 AAGW02080980 GL019610 GL019592 GL019601 GL019604 GL019632 AAGW02081012 GL019621 GL019613 GL019656 GL019684 GL019617 GL019614 GL019622 GL019615 GL019637 AAGW02081119 GL019635 AAGW02081122 GL019625 GL019624 GL019629 AAGW02081136 GL019631 AAGW02081154 AAGW02081155 AAGW02081156 GL019645 AAGW02081157 AAGW02081158 AAGW02081159 AAGW02081160 AAGW02081161 GL019661 GL019630 AAGW02081169 GL019639 GL019653 GL019648 GL019643 AAGW02081209 GL019652 AAGW02081222 GL019660 GL019677 AAGW02081234 GL019691 GL019651 AAGW02081239 GL019717 GL019721 AAGW02081247 GL019670 GL019659 GL019650 GL019666 AAGW02081253 GL019654 GL019676 GL019702 GL019706 GL019671 GL019662 GL019663 GL019669 GL019708 GL019665 AAGW02081303 AAGW02081305 AAGW02081306 AAGW02081327 AAGW02081335 GL019701 GL019750 GL019699 AAGW02081336 AAGW02081337 GL019690 AAGW02081354 GL019675 AAGW02081359 GL019681 GL019723 GL019687 AAGW02081395 GL019689 AAGW02081400 AAGW02081401 GL019705 AAGW02081404 AAGW02081405 GL019704 GL019694 AAGW02081422 AAGW02081425 GL019726 GL019707 GL019771 GL019700 GL019714 GL019730 GL019735 GL019731 GL019778 GL019755 GL019710 AAGW02081479 AAGW02081480 AAGW02081485 GL019802 GL019729 AAGW02081496 GL019733 GL019809 GL019719 GL019715 GL019720 AAGW02081504 GL019743 GL019744 GL019751 GL019736 AAGW02081550 AAGW02081566 GL019737 AAGW02081578 GL019738 AAGW02081581 GL019741 AAGW02081593 AAGW02081594 GL019791 GL019772 GL019770 GL019745 GL019762 GL019783 AAGW02081600 AAGW02081601 GL019774 GL019753 GL019754 GL019757 AAGW02081617 GL019748 GL019814 GL019756 AAGW02081636 AAGW02081638 GL019758 GL019779 GL019765 GL019821 GL019803 GL019776 GL019824 GL019777 AAGW02081685 AAGW02081690 AAGW02081691 GL019806 GL019794 GL019775 AAGW02081706 GL019795 GL019832 GL019793 GL019797 GL019804 GL019787 AAGW02081745 GL019838 AAGW02081760 AAGW02081763 AAGW02081764 GL019823 GL019863 AAGW02081790 GL019807 GL019829 AAGW02081804 AAGW02081808 AAGW02081815 AAGW02081818 GL019808 GL019840 GL019810 GL019817 GL019813 AAGW02081834 GL019887 AAGW02081847 AAGW02081860 AAGW02081861 AAGW02081866 GL019836 AAGW02081878 GL019849 GL019848 AAGW02081905 AAGW02081907 AAGW02081918 GL019865 AAGW02081927 GL019839 GL019845 AAGW02081958 AAGW02081959 GL019843 GL019850 GL019871 AAGW02081973 GL019864 AAGW02081976 GL019862 GL019854 GL019895 GL019851 AAGW02081992 AAGW02081999 AAGW02082000 AAGW02082012 GL019882 AAGW02082026 GL019866 GL019861 GL019868 AAGW02082043 AAGW02082045 AAGW02082046 AAGW02082051 AAGW02082054 GL019885 AAGW02082059 AAGW02082062 GL019878 GL019873 AAGW02082071 AAGW02082078 GL019875 AAGW02082083 AAGW02082086 AAGW02082089 GL019883 AAGW02082100 AAGW02082108 AAGW02082109 AAGW02082111 GL019898 AAGW02082113 AAGW02082117 AAGW02082131 AAGW02082132 AAGW02082136 AAGW02082138 AAGW02082145 AAGW02082147 AAGW02082152 AAGW02082157 GL019896 AAGW02082162 GL019897 AAGW02082163 GL019893 AAGW02082173 AAGW02082184 GL019894 GL019892 GL019906 AAGW02082188 AAGW02082198 AAGW02082208 AAGW02082210 AAGW02082218 AAGW02082230 AAGW02082231 AAGW02082232 AAGW02082235 AAGW02082236 GL019901 AAGW02082242 AAGW02082245 GL019914 GL019904 GL019911 GL019908 GL019905 AAGW02082252 AAGW02082269 AAGW02082270 AAGW02082273 AAGW02082281 AAGW02082282 AAGW02082283 AAGW02082292 GL019917 GL019926 AAGW02082319 GL019928 AAGW02082329 GL019922 AAGW02082333 AAGW02082338 AAGW02082344 AAGW02082351 AAGW02082355 AAGW02082356 AAGW02082360 AAGW02082368 AAGW02082379 AAGW02082380 AAGW02082383 AAGW02082390 GL019933 AAGW02082392 AAGW02082401 AAGW02082411 AAGW02082420 AAGW02082430 AAGW02082431 AAGW02082439 AAGW02082447 AAGW02082462 AAGW02082464 AAGW02082465 GL019942 GL019953 AAGW02082472 AAGW02082490 GL019957 AAGW02082497 AAGW02082499 AAGW02082500 AAGW02082501 AAGW02082508 AAGW02082510 AAGW02082511 GL019950 GL019955 AAGW02082537 AAGW02082539 AAGW02082540 AAGW02082551 AAGW02082559 AAGW02082563 AAGW02082564 AAGW02082565 AAGW02082567 AAGW02082581 AAGW02082587 AAGW02082591 AAGW02082596 AAGW02082603 AAGW02082605 AAGW02082613 AAGW02082616 AAGW02082617 AAGW02082618 AAGW02082620 AAGW02082622 AAGW02082626 AAGW02082637 AAGW02082641 AAGW02082642 AAGW02082651 AAGW02082660 AAGW02082662 AAGW02082666 AAGW02082671 AAGW02082674 AAGW02082679 AAGW02082682 AAGW02082683 AAGW02082720 AAGW02082729 AAGW02082736 AAGW02082741 AAGW02082749 AAGW02082757 AAGW02082759 AAGW02082764 AAGW02082765 GL019967 AAGW02082773 AAGW02082778 AAGW02082784 AAGW02082785 AAGW02082802 AAGW02082806 AAGW02082808 AAGW02082812 AAGW02082817 AAGW02082830 AAGW02082832 AAGW02082834 AAGW02082844 AAGW02082845 AAGW02082849 AAGW02082851 AAGW02082852 AAGW02082860 AAGW02082866 AAGW02082876 AAGW02082878 AAGW02082887 AAGW02082888 AAGW02082891 AAGW02082894 AAGW02082907 AAGW02082911 AAGW02082918 AAGW02082925 AAGW02082936 AAGW02082940 AAGW02082949 AAGW02082954 AAGW02082959 AAGW02082971 AAGW02082970 AAGW02082973 AAGW02082975 AAGW02082976 AAGW02082985 AAGW02082986 AAGW02082987 AAGW02082989 AAGW02082996 AAGW02083004 AAGW02083026 AAGW02083050 AAGW02083055 AAGW02083056 AAGW02083058 AAGW02083060 AAGW02083071 AAGW02083072 AAGW02083089 AAGW02083094 AAGW02083097 AAGW02083102 AAGW02083105 GL019983 AAGW02083110 AAGW02083111 AAGW02083131 AAGW02083133 AAGW02083138 AAGW02083141 AAGW02083152 AAGW02083157 AAGW02083174 AAGW02083223 AAGW02083224 AAGW02083225 AAGW02083233 AAGW02083240 AAGW02083241 AAGW02083242 AAGW02083248 AAGW02083249 AAGW02083253 AAGW02083265 AAGW02083268 AAGW02083270 AAGW02083272 AAGW02083273 AAGW02083280 AAGW02083286 AAGW02083294 AAGW02083298 AAGW02083308 AAGW02083323 AAGW02083342 AAGW02083348 AAGW02083362 AAGW02083364 AAGW02083371 AAGW02083408 AAGW02083426 AAGW02083432 AAGW02083433 AAGW02083441 AAGW02083443 AAGW02083445 AAGW02083457 AAGW02083472 AAGW02083478 AAGW02083485 AAGW02083488 AAGW02083505 AAGW02083514 AAGW02083516 AAGW02083525 AAGW02083526 AAGW02083527 AAGW02083529 AAGW02083553 AAGW02083567 AAGW02083570 AAGW02083572 AAGW02083599 AAGW02083619 AAGW02083628 AAGW02083647 AAGW02083648 AAGW02083656 AAGW02083663 AAGW02083671 AAGW02083676 AAGW02083697 AAGW02083703 AAGW02083711 AAGW02083714 AAGW02083722 AAGW02083724 AAGW02083732 AAGW02083735 AAGW02083771 AAGW02083777 AAGW02083784 AAGW02083790 AAGW02083795 AAGW02083818 AAGW02083819 AAGW02083827 AAGW02083842 GL020024 AAGW02083855 AAGW02083877 AAGW02083887 AAGW02083897 AAGW02083905 AAGW02083912 AAGW02083914 AAGW02083957 AAGW02084006 ";

#show print statements immediately
$|=1;

# annotation from Gencode, extract HAVANA exons information
# make sure the Gencode version matches the reference genome version used by STAR for mapping
open GTF, $gtf or die "Cannot find gtf file";
while ($line=<GTF>) {
    chomp $line;
    @fields = split "\t", $line;
    if ($fields[2] eq "exon" ){ # && $fields[1] eq "HAVANA") {
	#chr_exon start
	$uni = $fields[0]."_".$fields[3];
	
	#chr_exon end
	$uni2 = $fields[0]."_".$fields[4];
	
	#annot
	$temp = $fields[8];
	$temp =~ s/"//g;
	$temp =~ /gene_id (.+?);.+gene_name (.+?);.+exon_id (.+?);/;
# $ensembl = $1; $name = $2; $exon = $3;
	$annot = $1."\t".$2."\t".$3;
	unless (defined $gtf_annot{$uni}) {
	    $gtf_annot{$uni} = $annot;
	}
	unless (defined $gtf_annot{$uni2}) {
	    $gtf_annot{$uni2} = $annot;
	}
    }
}
print "GTF loaded\n";
find(\&process_file, $dir);


sub process_file {
    $open = $File::Find::name;
    
    #loop per bam-file
    if ($open =~ /\.bam$/) {
	
	$sample_name = $_;
	# optionally parse $_ to get a cleaner sample_name for output
	open (TRIO, ">".$outdir.$sample_name."_trio.sam" );
	print "running ",$sample_name,"\n";
	
	# get reads using samtools, -F 4 for mapped reads only
	open IN, $samdir."samtools view -F 4 $open $chr_string |"  or die "cannot find input bam $open";
	open OUT, ">".$outdir.$sample_name."_mapped_circRNA.txt";
	
	#reset variables for new sample
	$start=time();$row=0;undef %wanted;undef %region; undef %region_flag;
	undef %flags; $correct_count=$regions_count=0;
	
      LBL1:while ($line=<IN>) {
	  $row++;
	  if ($row%10000000==0) {print $sample_name,": ",$row,"\n";}
	  
	  @fields = split "\t", $line;
	  # just to really make sure it doesn't parse MT if ppl remove $chr_string
	  if ($fields[2] eq "chrM") {
	      close IN;
	      last LBL1;
	      print "oops. parsing chrM is a bad idea\n";
	  }
	  
	  #prevent match of flag 145 129
	  $temp = " ".$fields[1];
	  
	  #check flag pattern for wanted reads, only use uniquely mapped (MAPQ==255)
	  if ($pattern =~ /$temp/ && $fields[4]==255) {
	      chomp $line;
	      
	      #fill hash by readname
	      push @{$wanted{$fields[0]}}, $line;
	      next LBL1;
	  }
	  if ($pattern2 =~ /$fields[1]/ && $fields[4]==255) {
	      chomp $line;
	      # contains proper pair flags; check for secondary alignment label and MAPQ of 255 (unique map)
	      # in STAR mapped bam file, the secondary alignment is present in the last field
	      # if data has been MarkDuplicate by Picard, then it is not the last field, but in 1 case field[11]
	      # not sure if this field - after MarkDup by Picard - is universal
	      
	      # after STAR
	      if ($fields[$#fields] =~ /^SA:Z/) {
		  
		  #after STAR & Markduplicate
		  #if ($fields[11] =~ /^SA:Z/) {
		  #$flag{$fields[1]}++;
		  
		  #fill hash by readname
		  push @{$wanted{$fields[0]}}, $line;
		  
		  next LBL1;
		  
	      }
	      # but also the third partner is needed; this read does not have secondary alignment
	      # will only be needed/present if either the 21xx read has been seen, or the one with the SA label
	      if (defined $wanted{$fields[0]}) {
		  push @{$wanted{$fields[0]}}, $line;
	      }
	  }
	  
      }
	$inter=time();print "all lines parsed in ",$inter-$start," seconds\n";
	
	# reads indicative of circRNA have specific order of flags
	# several possibilities depending on read orientations
	$correct = " 2129_163_83 83_163_2129 2209_83_163 163_83_2209 2193_99_147 147_99_2193 2145_147_99 99_147_2145";
	
	# now check for circular RNA
	foreach $readname (keys %wanted) {

	    # we need a trio
	    if (scalar @{$wanted{$readname}} == 3) {
		
		# need certain combinations in the correct order, so get order of flags for this read
		$flag=" ";
		for $i (0..2) {
		    $temp=$wanted{$readname}[$i];
		    print TRIO "$temp\n";
		    @fields=split "\t", $temp;
		    $flag .= $fields[1]."_";
		    # while we are here, save some data
		    if ($i==0) { $junction_left = $fields[3]; $chr_left=$fields[2];}
		    if ($i==1) { $chr_middle=$fields[2];}
		    if ($i==2) { $pos_right = $fields[3]; $cigar_right = $fields[5]; $SA = $fields[$#fields];}
		}
		#remove last _
		chop $flag;
		
		
		# check if this is a combi plus order indicative of circular read
		if ($correct =~ /$flag/) {
		    #check if all reads are on same chromosome
		    if ($SA =~ /SA:Z:(.+?),/) {
			if ($1 eq $chr_left) {
			    if ($chr_left eq $chr_middle) {
				$correct_count++;
				
				# gather region info for output
				# the left junction is the mapped position (5' start pos of read)
				# the right junction is the mapped position plus the number of matches
				# as listed by CIGAR. The CIGAR score always must be xxMyyH, or at least 1 or more digits followed by M
				$cigar_right =~ /(\d+)M/;
				$junction_right = $pos_right + $1 - 1;
				$uni = $chr_left.":".$junction_left."-".$junction_right;
				$region{$uni}++;
				$region_flag{$uni}{$flag}++;
				$flags{$flag}=1;
			    }
			}
		    }
		    
		}
	    }
	}
	print $correct_count," circular trio's found.\nFinding regions in gtf and output\n";
	
	# match with gencode
	# if no match, then still output
	# OUTPUT has region where circRNA has start and end-point (Chr-start-end),
	# the total number of reads supporting the junction, also specified by flag type
	# size of region (end-start), followed by annotation, if matching with HAVANA exons
 
	print OUT "Region\tTotal";
	foreach $flag (keys %flags) {
	    print OUT "\t",$flag;
	}
	print OUT "\tSize\tEnsemble_start\tGene_start\texon_number_start\tEnsemble_end\tGene_end\texon_number_end\n";
	
	foreach $region (keys %region) {
	    $regions_count++;
	    print OUT $region,"\t",$region{$region};
	    foreach $flag (keys %flags) {
		print OUT "\t",$region_flag{$region}{$flag};
	    }
	    #split region for matchin with Encode
	    $region =~ /(.+):(\d+)-(\d+)/;
	    print OUT "\t",$3-$2,"\t";
	    $uni = $1."_".$2;
	    
	    if (defined $gtf_annot{$uni}) {
		print OUT $gtf_annot{$uni},"\t";
	    } else {
		print OUT "\t\t\t";
	    }
	    $temp=$3;
	    $uni = $1."_".$temp;
	    if (defined $gtf_annot{$uni}) {
		print OUT $gtf_annot{$uni},"\n";
	    } else {
		print OUT "\n";
	    }
	}
	$end = time();
	print $regions_count," regions found.\nTotal runtime: ",$end-$start," seconds.\n\n";
	close;
	
    } # end of bam loop

} # end of process dir loop
